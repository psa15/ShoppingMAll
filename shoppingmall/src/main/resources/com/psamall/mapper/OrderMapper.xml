<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.psamall.mapper.OrderMapper">

	<!-- 주문 페이지 주문 상품 목록 - 장바구니에서 주문 -->
	<select id="orderCartList" resultType="com.psamall.domain.OrderCartListVO">
	
		SELECT
	        C.CART_CODE, C.P_NUM, C.M_ID, C.CART_AMOUNT,
	        P. P_NAME, P.P_COST, P.P_DISCOUNT, P.P_COMPANY, P.P_IMAGE, P.P_IMAGE_FOLDER
		FROM 
			TBL_CART C INNER JOIN TBL_PRODUCT P
		ON 
			C.P_NUM = P.P_NUM
		WHERE 
		    C.M_ID = #{m_id}
	
	</select>
	
	<!-- 장바구니 외 주문 -->
	<select id="orderDirectList" resultType="com.psamall.domain.OrderCartListVO">
	
		SELECT
	        P_NUM, P_NAME, P_COST, P_DISCOUNT, P_COMPANY, P_IMAGE, P_IMAGE_FOLDER, #{ord_amount} as CART_AMOUNT
		FROM 
			TBL_PRODUCT P
		WHERE 
		    P_NUM = #{p_num}
	
	</select>
	
	<!-- 최근 배송지 불러오기 -->
	<select id="getRecentAddr">
	
	
	</select>
	
	<!-- 주문 저장  1)주문 테이블 -->
	<insert id="insertOrder">
	
		<selectKey resultType="LONG" order="BEFORE" keyProperty="ord_code">
			SELECT SEQ_ORDER_CODE.nextval FROM dual
		</selectKey>
		
		INSERT INTO 
			TBL_ORDER
				(ORD_CODE, M_ID, ORD_NAME, ORD_POSTCODE, ORD_ADDR, ORD_ADDR_D, ORD_TEL, ORD_TOTALCOST, ORD_MESSAGE, ORD_EMAIL) 
			VALUES
				(#{ord_code}, #{m_id}, #{ord_name}, #{ord_postcode}, #{ord_addr}, #{ord_addr_d}, #{ord_tel}, #{ord_totalcost}, #{ord_message}, #{ord_email})
				
	</insert>
	
	<!-- 주문 저장 2)주문 상세테이블 -->
	<insert id="insertOrderDetail">
	
		INSERT INTO
			TBL_ORDER_D(ORD_CODE, P_NUM, ORD_AMOUNT, ORD_COST)
		SELECT 
			#{ord_code}, C.P_NUM, C.CART_AMOUNT, C.P_NUM * P.P_COST
		FROM 
			TBL_CART C INNER JOIN TBL_PRODUCT P
	        ON 
	        	C.P_NUM = P.P_NUM
	        WHERE 
	        	M_ID = #{m_id} AND C.P_NUM = #{p_num}
	
	</insert>
	

</mapper>